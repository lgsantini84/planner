<!-- templates/tasks/list.html -->
{% extends "base.html" %}

{% block title %}Tarefas - Planner Dashboard PRO{% endblock %}

{% block head %}
<style>
    /* Additional styles for tasks page */
    .task-card {
        border-left: 4px solid var(--primary-color);
        margin-bottom: 15px;
        transition: all 0.3s ease;
    }
    
    .task-card:hover {
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .task-card.overdue {
        border-left-color: var(--danger-color);
    }
    
    .task-card.completed {
        border-left-color: var(--success-color);
        opacity: 0.8;
    }
    
    .task-card.high-priority {
        border-left-color: var(--danger-color);
    }
    
    .task-card.medium-priority {
        border-left-color: var(--warning-color);
    }
    
    .task-card.low-priority {
        border-left-color: var(--info-color);
    }
    
    .task-status-badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
    }
    
    .task-priority-badge {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 0.7rem;
        font-weight: bold;
        color: white;
    }
    
    .priority-urgent { background-color: #dc3545; }
    .priority-high { background-color: #e74c3c; }
    .priority-medium { background-color: #f39c12; }
    .priority-low { background-color: #3498db; }
    
    .filter-card {
        background-color: #f8f9fa;
        border: 1px solid #e9ecef;
    }
    
    .filter-section {
        border-bottom: 1px solid #dee2e6;
        padding-bottom: 15px;
        margin-bottom: 15px;
    }
    
    .filter-section:last-child {
        border-bottom: none;
    }
    
    .task-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background-color: #3498db;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
    }
    
    .progress-thin {
        height: 6px;
        margin-top: 8px;
    }
    
    /* Kanban column styles */
    .kanban-column {
        min-height: 500px;
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        border: 1px solid #dee2e6;
    }
    
    .kanban-column-header {
        font-weight: 600;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid;
    }
    
    .kanban-column.not-started .kanban-column-header {
        color: #6c757d;
        border-bottom-color: #6c757d;
    }
    
    .kanban-column.in-progress .kanban-column-header {
        color: #ffc107;
        border-bottom-color: #ffc107;
    }
    
    .kanban-column.completed .kanban-column-header {
        color: #28a745;
        border-bottom-color: #28a745;
    }
    
    .kanban-column.overdue .kanban-column-header {
        color: #dc3545;
        border-bottom-color: #dc3545;
    }
    
    /* Responsive table */
    .table-responsive {
        overflow-x: auto;
    }
    
    /* View toggle buttons */
    .view-toggle .btn {
        border-radius: 4px;
        padding: 6px 12px;
    }
    
    /* Drag and drop */
    .task-draggable {
        cursor: move;
    }
    
    .task-draggable.dragging {
        opacity: 0.5;
        border: 2px dashed #3498db;
    }
    
    .kanban-column.drop-target {
        background-color: rgba(52, 152, 219, 0.1);
        border: 2px dashed #3498db;
    }
    
    .avatar {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        margin-right: 5px;
    }
    
    .avatar-sm {
        width: 24px;
        height: 24px;
        font-size: 0.7rem;
    }
    
    .avatar-group {
        display: flex;
    }
    
    .avatar-initials {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
    }
    
    /* Fix for Bootstrap modal backdrop */
    .modal-backdrop {
        z-index: 1040;
    }
    
    .modal {
        z-index: 1050;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid fade-in">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h1 class="h2 mb-0">
                <i class="fas fa-tasks me-2 text-primary"></i> Tarefas
            </h1>
            <p class="text-muted mb-0">Gerencie e visualize suas tarefas do Microsoft Planner</p>
        </div>
        <div class="col-md-4 text-end">
            <div class="btn-group view-toggle mb-2" role="group">
                <button type="button" id="viewTable" class="btn btn-outline-primary active">
                    <i class="fas fa-table"></i> Tabela
                </button>
                <button type="button" id="viewKanban" class="btn btn-outline-primary">
                    <i class="fas fa-columns"></i> Kanban
                </button>
                <button type="button" id="viewCards" class="btn btn-outline-primary">
                    <i class="fas fa-th-large"></i> Cartões
                </button>
            </div>
            <button class="btn btn-primary" id="filterButton">
                <i class="fas fa-filter me-1"></i> Filtros
                {% if filter_params %}
                <span class="badge bg-danger ms-1">{{ filter_params|length }}</span>
                {% endif %}
            </button>
            <button class="btn btn-success" id="exportButton">
                <i class="fas fa-file-export me-1"></i> Exportar
            </button>
        </div>
    </div>

    <!-- Filter Summary -->
    {% if filter_params %}
    <div class="row mb-3">
        <div class="col-12">
            <div class="card filter-card">
                <div class="card-body py-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <small class="text-muted">Filtros ativos:</small>
                            {% for key, value in filter_params.items() %}
                                {% if value and value != 'false' and value != 'true' %}
                                <span class="badge bg-info me-1">
                                    {{ key }}: {{ value }}
                                    <a href="?{% for k, v in filter_params.items() %}{% if k != key and v and v != 'false' and v != 'true' %}{{ k }}={{ v }}&{% endif %}{% endfor %}" 
                                       class="text-white ms-1">
                                        <i class="fas fa-times"></i>
                                    </a>
                                </span>
                                {% endif %}
                            {% endfor %}
                        </div>
                        <div>
                            <a href="?" class="btn btn-sm btn-outline-danger">
                                <i class="fas fa-times me-1"></i> Limpar Filtros
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Saved Filters -->
    {% if saved_filters %}
    <div class="row mb-3">
        <div class="col-12">
            <div class="card">
                <div class="card-header py-2">
                    <h6 class="mb-0"><i class="fas fa-bookmark me-2 text-warning"></i>Filtros Salvos</h6>
                </div>
                <div class="card-body py-2">
                    <div class="d-flex flex-wrap gap-2">
                        {% for filter in saved_filters %}
                        {% set filter_data = filter.get_filters() %}
                        <a href="?{% for k, v in filter_data.items() %}{{ k }}={{ v }}&{% endfor %}" 
                           class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-filter me-1"></i> {{ filter.name }}
                            <span class="badge bg-secondary ms-1">{{ filter.usage_count }}</span>
                        </a>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Table View (Default) -->
    <div id="tableView" class="view-content">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Lista de Tarefas</h5>
                    <div>
                        <span class="text-muted">
                            {% if tasks and tasks.total is defined %}
                                {{ tasks.total }} tarefas encontradas
                                {% if tasks.has_prev or tasks.has_next %}
                                (Página {{ tasks.page }} de {{ tasks.pages }})
                                {% endif %}
                            {% else %}
                                0 tarefas encontradas
                            {% endif %}
                        </span>
                    </div>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th width="50">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="selectAll">
                                    </div>
                                </th>
                                <th width="60">Prioridade</th>
                                <th>Título</th>
                                <th width="150">Planner</th>
                                <th width="100">Status</th>
                                <th width="100">Progresso</th>
                                <th width="120">Vencimento</th>
                                <th width="150">Responsáveis</th>
                                <th width="100">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if tasks and tasks.items %}
                            {% for task_item in tasks.items %}
                            {% set assignments = task_item.get_assignments() %}
                            <tr class="task-row 
                                {% if task_item.is_overdue %}table-danger{% endif %}
                                {% if task_item.status.value == 'completed' %}table-success{% endif %}
                                {% if task_item.status.value == 'in_progress' %}table-warning{% endif %}">
                                <td>
                                    <div class="form-check">
                                        <input class="form-check-input task-checkbox" type="checkbox" value="{{ task_item.id }}">
                                    </div>
                                </td>
                                <td>
                                    {% if task_item.priority and task_item.priority.value == 3 %}
                                    <span class="task-priority-badge priority-urgent" title="Urgente">U</span>
                                    {% elif task_item.priority and task_item.priority.value == 2 %}
                                    <span class="task-priority-badge priority-high" title="Alta">A</span>
                                    {% elif task_item.priority and task_item.priority.value == 1 %}
                                    <span class="task-priority-badge priority-medium" title="Média">M</span>
                                    {% elif task_item.priority %}
                                    <span class="task-priority-badge priority-low" title="Baixa">B</span>
                                    {% else %}
                                    <span class="task-priority-badge priority-low" title="Baixa">B</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="d-flex align-items-start">
                                        <div class="me-2">
                                            {% if task_item.is_overdue %}
                                            <i class="fas fa-exclamation-triangle text-danger" title="Atrasada"></i>
                                            {% elif task_item.is_urgent %}
                                            <i class="fas fa-clock text-warning" title="Urgente"></i>
                                            {% elif task_item.status and task_item.status.value == 'completed' %}
                                            <i class="fas fa-check-circle text-success" title="Concluída"></i>
                                            {% endif %}
                                        </div>
                                        <div>
                                            <strong>{{ task_item.title[:60] if task_item.title else 'Sem título' }}{% if task_item.title and task_item.title|length > 60 %}...{% endif %}</strong>
                                            {% if task_item.description %}
                                            <small class="d-block text-muted">{{ task_item.description[:100] if task_item.description else '' }}{% if task_item.description and task_item.description|length > 100 %}...{% endif %}</small>
                                            {% endif %}
                                            {% if task_item.labels %}
                                            <div class="mt-1">
                                                {% for label in task_item.get_labels() %}
                                                <span class="badge bg-secondary me-1">{{ label }}</span>
                                                {% endfor %}
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    {% if task_item.planner %}
                                    <div class="d-flex align-items-center">
                                        <div class="task-avatar me-2" style="background-color: {{ task_item.planner.color if task_item.planner.color else '#3498db' }}">
                                            {{ task_item.planner.title[0].upper() if task_item.planner and task_item.planner.title else 'P' }}
                                        </div>
                                        <div>
                                            <small class="d-block">{{ task_item.planner.title[:20] if task_item.planner.title else '' }}{% if task_item.planner.title and task_item.planner.title|length > 20 %}...{% endif %}</small>
                                            {% if task_item.planner.group %}
                                            <small class="text-muted">{{ task_item.planner.group.name[:15] if task_item.planner.group.name else '' }}{% if task_item.planner.group.name and task_item.planner.group.name|length > 15 %}...{% endif %}</small>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if not task_item.status %}
                                    <span class="badge bg-secondary task-status-badge">Desconhecido</span>
                                    {% elif task_item.status.value == 'not_started' %}
                                    <span class="badge bg-secondary task-status-badge">Não Iniciada</span>
                                    {% elif task_item.status.value == 'in_progress' %}
                                    <span class="badge bg-warning text-dark task-status-badge">Em Progresso</span>
                                    {% elif task_item.status.value == 'completed' %}
                                    <span class="badge bg-success task-status-badge">Concluída</span>
                                    {% elif task_item.status.value == 'overdue' %}
                                    <span class="badge bg-danger task-status-badge">Atrasada</span>
                                    {% elif task_item.status.value == 'blocked' %}
                                    <span class="badge bg-dark task-status-badge">Bloqueada</span>
                                    {% else %}
                                    <span class="badge bg-secondary task-status-badge">{{ task_item.status.value }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="progress progress-thin">
                                        <div class="progress-bar 
                                            {% if task_item.percent_complete == 100 %}bg-success
                                            {% elif task_item.percent_complete >= 50 %}bg-warning
                                            {% else %}bg-info{% endif %}" 
                                             role="progressbar" 
                                             style="width: {{ task_item.percent_complete }}%"
                                             aria-valuenow="{{ task_item.percent_complete }}" 
                                             aria-valuemin="0" 
                                             aria-valuemax="100">
                                        </div>
                                    </div>
                                    <small class="text-muted">{{ task_item.percent_complete }}%</small>
                                </td>
                                <td>
                                    {% if task_item.due_date %}
                                    {% set due_date = task_item.due_date %}
                                    {% if due_date.tzinfo %}{% set due_date = due_date.replace(tzinfo=None) %}{% endif %}
                                    {% set now = now_date %}
                                    {% if now.tzinfo %}{% set now = now.replace(tzinfo=None) %}{% endif %}
                                    {% set diff_days = (due_date - now).days %}
                                    
                                    {% if task_item.status and task_item.status.value == 'completed' %}
                                    <span class="text-success">{{ task_item.due_date.strftime('%d/%m/%Y') }}</span>
                                    {% elif diff_days < 0 %}
                                    <span class="text-danger">{{ task_item.due_date.strftime('%d/%m/%Y') }}</span>
                                    <small class="d-block text-danger">Atrasada há {{ -diff_days }} dias</small>
                                    {% elif diff_days == 0 %}
                                    <span class="text-warning">Hoje</span>
                                    <small class="d-block text-warning">Vence hoje</small>
                                    {% elif diff_days == 1 %}
                                    <span class="text-warning">Amanhã</span>
                                    {% elif diff_days <= 7 %}
                                    <span class="text-warning">{{ task_item.due_date.strftime('%d/%m/%Y') }}</span>
                                    <small class="d-block text-warning">Em {{ diff_days }} dias</small>
                                    {% else %}
                                    <span>{{ task_item.due_date.strftime('%d/%m/%Y') }}</span>
                                    <small class="d-block text-muted">Em {{ diff_days }} dias</small>
                                    {% endif %}
                                    {% else %}
                                    <span class="text-muted">Sem data</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if assignments and assignments is mapping %}
                                    <div class="d-flex align-items-center">
                                        <div class="avatar-group">
                                            {% for user_id, assignment in assignments.items() %}
                                            {% if loop.index <= 3 %}
                                            {% set display_name = assignment.get('userDisplayName') or assignment.get('userEmail') or 'Usuário' %}
                                            {% set initials = display_name[0].upper() if display_name else 'U' %}
                                            <div class="avatar avatar-sm" 
                                                 title="{{ display_name }}"
                                                 data-bs-toggle="tooltip">
                                                <span class="avatar-initials bg-primary text-white">
                                                    {{ initials }}
                                                </span>
                                            </div>
                                            {% endif %}
                                            {% endfor %}
                                            {% if assignments|length > 3 %}
                                            <div class="avatar avatar-sm">
                                                <span class="avatar-initials bg-secondary text-white">
                                                    +{{ assignments|length - 3 }}
                                                </span>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% else %}
                                    <span class="text-muted">Não atribuída</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <a href="{{ url_for('tasks.task_detail', task_id=task_item.id) }}" 
                                           class="btn btn-outline-primary" title="Detalhes">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <button type="button" class="btn btn-outline-secondary dropdown-toggle" 
                                                data-bs-toggle="dropdown" aria-expanded="false">
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end">
                                            <li>
                                                <a class="dropdown-item" href="#" onclick="return quickUpdateStatus('{{ task_item.id }}', 'completed')">
                                                    <i class="fas fa-check text-success me-2"></i>Marcar como concluída
                                                </a>
                                            </li>
                                            <li>
                                                <a class="dropdown-item" href="#" onclick="return quickUpdateStatus('{{ task_item.id }}', 'in_progress')">
                                                    <i class="fas fa-play text-warning me-2"></i>Em progresso
                                                </a>
                                            </li>
                                            <li><hr class="dropdown-divider"></li>
                                            <li>
                                                <a class="dropdown-item" href="#" onclick="return editTask('{{ task_item.id }}')">
                                                    <i class="fas fa-edit me-2"></i>Editar
                                                </a>
                                            </li>
                                            <li>
                                                <a class="dropdown-item text-danger" href="#" 
                                                   onclick="return confirmDelete('{{ task_item.id }}')">
                                                    <i class="fas fa-trash me-2"></i>Excluir
                                                </a>
                                            </li>
                                        </ul>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                            {% else %}
                            <tr>
                                <td colspan="9" class="text-center py-4">
                                    <div class="py-5">
                                        <i class="fas fa-tasks fa-3x text-muted mb-3"></i>
                                        <h5>Nenhuma tarefa encontrada</h5>
                                        <p class="text-muted">Tente ajustar seus filtros ou sincronizar os dados.</p>
                                        <a href="{{ url_for('api.sync_data') }}" class="btn btn-primary">
                                            <i class="fas fa-sync me-1"></i> Sincronizar Dados
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Pagination -->
            {% if tasks and tasks.pages > 1 %}
            <div class="card-footer">
                <nav aria-label="Navegação de páginas">
                    <ul class="pagination justify-content-center mb-0">
                        <li class="page-item {% if not tasks.has_prev %}disabled{% endif %}">
                            <a class="page-link" href="?page=1{% for k, v in filter_params.items() %}{% if v and v != 'false' and v != 'true' %}&{{ k }}={{ v }}{% endif %}{% endfor %}">
                                <i class="fas fa-angle-double-left"></i>
                            </a>
                        </li>
                        <li class="page-item {% if not tasks.has_prev %}disabled{% endif %}">
                            <a class="page-link" href="?page={{ tasks.prev_num }}{% for k, v in filter_params.items() %}{% if v and v != 'false' and v != 'true' %}&{{ k }}={{ v }}{% endif %}{% endfor %}">
                                <i class="fas fa-angle-left"></i>
                            </a>
                        </li>
                        
                        {% for page_num in range(1, tasks.pages + 1) %}
                            {% if page_num >= tasks.page - 2 and page_num <= tasks.page + 2 %}
                                <li class="page-item {% if page_num == tasks.page %}active{% endif %}">
                                    <a class="page-link" href="?page={{ page_num }}{% for k, v in filter_params.items() %}{% if v and v != 'false' and v != 'true' %}&{{ k }}={{ v }}{% endif %}{% endfor %}">
                                        {{ page_num }}
                                    </a>
                                </li>
                            {% endif %}
                        {% endfor %}
                        
                        <li class="page-item {% if not tasks.has_next %}disabled{% endif %}">
                            <a class="page-link" href="?page={{ tasks.next_num }}{% for k, v in filter_params.items() %}{% if v and v != 'false' and v != 'true' %}&{{ k }}={{ v }}{% endif %}{% endfor %}">
                                <i class="fas fa-angle-right"></i>
                            </a>
                        </li>
                        <li class="page-item {% if not tasks.has_next %}disabled{% endif %}">
                            <a class="page-link" href="?page={{ tasks.pages }}{% for k, v in filter_params.items() %}{% if v and v != 'false' and v != 'true' %}&{{ k }}={{ v }}{% endif %}{% endfor %}">
                                <i class="fas fa-angle-double-right"></i>
                            </a>
                        </li>
                    </ul>
                    <div class="text-center mt-2">
                        <small class="text-muted">
                            Mostrando {{ tasks.items|length }} de {{ tasks.total }} tarefas
                        </small>
                    </div>
                </nav>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Kanban View (Hidden by default) -->
    <div id="kanbanView" class="view-content" style="display: none;">
        <div class="row">
            <div class="col-lg-3 mb-3">
                <div class="kanban-column not-started">
                    <div class="kanban-column-header d-flex justify-content-between align-items-center">
                        <span>Não Iniciadas</span>
                        <span class="badge bg-secondary" id="notStartedCount">0</span>
                    </div>
                    <div class="kanban-column-content" data-status="not_started">
                        <!-- Tasks will be loaded here via JavaScript -->
                    </div>
                </div>
            </div>
            <div class="col-lg-3 mb-3">
                <div class="kanban-column in-progress">
                    <div class="kanban-column-header d-flex justify-content-between align-items-center">
                        <span>Em Progresso</span>
                        <span class="badge bg-warning text-dark" id="inProgressCount">0</span>
                    </div>
                    <div class="kanban-column-content" data-status="in_progress">
                        <!-- Tasks will be loaded here via JavaScript -->
                    </div>
                </div>
            </div>
            <div class="col-lg-3 mb-3">
                <div class="kanban-column completed">
                    <div class="kanban-column-header d-flex justify-content-between align-items-center">
                        <span>Concluídas</span>
                        <span class="badge bg-success" id="completedCount">0</span>
                    </div>
                    <div class="kanban-column-content" data-status="completed">
                        <!-- Tasks will be loaded here via JavaScript -->
                    </div>
                </div>
            </div>
            <div class="col-lg-3 mb-3">
                <div class="kanban-column overdue">
                    <div class="kanban-column-header d-flex justify-content-between align-items-center">
                        <span>Atrasadas</span>
                        <span class="badge bg-danger" id="overdueCount">0</span>
                    </div>
                    <div class="kanban-column-content" data-status="overdue">
                        <!-- Tasks will be loaded here via JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Cards View (Hidden by default) -->
    <div id="cardsView" class="view-content" style="display: none;">
        <div class="row" id="cardsContainer">
            <!-- Cards will be loaded here via JavaScript -->
        </div>
        
        {% if tasks and tasks.pages > 1 %}
        <div class="row mt-4">
            <div class="col-12">
                <nav aria-label="Navegação de páginas">
                    <ul class="pagination justify-content-center">
                        {% for page_num in range(1, tasks.pages + 1) %}
                            {% if page_num >= tasks.page - 2 and page_num <= tasks.page + 2 %}
                            <li class="page-item {% if page_num == tasks.page %}active{% endif %}">
                                <a class="page-link" href="?page={{ page_num }}{% for k, v in filter_params.items() %}{% if v and v != 'false' and v != 'true' %}&{{ k }}={{ v }}{% endif %}{% endfor %}">
                                    {{ page_num }}
                                </a>
                            </li>
                            {% endif %}
                        {% endfor %}
                    </ul>
                </nav>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Filter Modal -->
<div class="modal fade" id="filterModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-filter me-2"></i>Filtros Avançados</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="GET" action="{{ url_for('tasks.list_tasks') }}" id="filterForm">
                <div class="modal-body">
                    <div class="row">
                        <!-- Status -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Status</label>
                            <div class="row">
                                {% for status_value, status_label in [('not_started', 'Não Iniciada'), ('in_progress', 'Em Progresso'), ('completed', 'Concluída'), ('overdue', 'Atrasada'), ('blocked', 'Bloqueada')] %}
                                <div class="col-6 mb-2">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" 
                                               name="status" value="{{ status_value }}" 
                                               id="status_{{ status_value }}"
                                               {% if status_value in (filter_params.get('status') or '').split(',') %}checked{% endif %}>
                                        <label class="form-check-label" for="status_{{ status_value }}">
                                            {{ status_label }}
                                        </label>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <!-- Priority -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Prioridade</label>
                            <div class="row">
                                {% for priority_value, priority_label in [('0', 'Baixa'), ('1', 'Média'), ('2', 'Alta'), ('3', 'Urgente')] %}
                                <div class="col-6 mb-2">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" 
                                               name="priority" value="{{ priority_value }}" 
                                               id="priority_{{ priority_value }}"
                                               {% if priority_value in (filter_params.get('priority') or '').split(',') %}checked{% endif %}>
                                        <label class="form-check-label" for="priority_{{ priority_value }}">
                                            {{ priority_label }}
                                        </label>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <!-- Planner -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Planner</label>
                            <select class="form-select" name="planner_id" id="plannerSelect">
                                <option value="">Todos os Planners</option>
                                {% for planner in planners %}
                                <option value="{{ planner.id }}" 
                                        {% if filter_params.get('planner_id')|string == planner.id|string %}selected{% endif %}>
                                    {{ planner.title }}
                                    {% if planner.group %}
                                    ({{ planner.group.name }})
                                    {% endif %}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <!-- Group -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Grupo</label>
                            <select class="form-select" name="group_id" id="groupSelect">
                                <option value="">Todos os Grupos</option>
                                {% for group in groups %}
                                <option value="{{ group.id }}"
                                        {% if filter_params.get('group_id')|string == group.id|string %}selected{% endif %}>
                                    {{ group.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <div class="row">
                        <!-- Date Range -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Período</label>
                            <select class="form-select" name="date_range" id="dateRangeSelect">
                                <option value="">Todos os períodos</option>
                                <option value="today" {% if filter_params.get('date_range') == 'today' %}selected{% endif %}>Hoje</option>
                                <option value="this_week" {% if filter_params.get('date_range') == 'this_week' %}selected{% endif %}>Esta semana</option>
                                <option value="overdue" {% if filter_params.get('date_range') == 'overdue' %}selected{% endif %}>Atrasadas</option>
                                <option value="next_7_days" {% if filter_params.get('date_range') == 'next_7_days' %}selected{% endif %}>Próximos 7 dias</option>
                                <option value="custom" {% if filter_params.get('date_range') == 'custom' %}selected{% endif %}>Personalizado</option>
                            </select>
                        </div>
                        
                        <!-- Progress -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Progresso</label>
                            <select class="form-select" name="progress" id="progressSelect">
                                <option value="">Todos</option>
                                <option value="not_started" {% if filter_params.get('progress') == 'not_started' %}selected{% endif %}>Não iniciadas (0%)</option>
                                <option value="in_progress" {% if filter_params.get('progress') == 'in_progress' %}selected{% endif %}>Em progresso (1-99%)</option>
                                <option value="completed" {% if filter_params.get('progress') == 'completed' %}selected{% endif %}>Concluídas (100%)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row" id="customDateRange" style="display: none;">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Data inicial</label>
                            <input type="date" class="form-control" name="start_date" 
                                   value="{{ filter_params.get('start_date', '') }}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Data final</label>
                            <input type="date" class="form-control" name="end_date" 
                                   value="{{ filter_params.get('end_date', '') }}">
                        </div>
                    </div>
                    
                    <div class="row">
                        <!-- Search -->
                        <div class="col-12 mb-3">
                            <label class="form-label">Buscar</label>
                            <input type="text" class="form-control" name="search" 
                                   placeholder="Buscar por título, descrição..."
                                   value="{{ filter_params.get('search', '') }}">
                        </div>
                    </div>
                    
                    <!-- Save Filter Option -->
                    <div class="row">
                        <div class="col-12">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="saveFilterCheck">
                                <label class="form-check-label" for="saveFilterCheck">
                                    Salvar estes filtros
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mt-2" id="saveFilterOptions" style="display: none;">
                        <div class="col-md-6 mb-2">
                            <input type="text" class="form-control" id="filterName" placeholder="Nome do filtro">
                        </div>
                        <div class="col-md-6 mb-2">
                            <input type="text" class="form-control" id="filterDescription" placeholder="Descrição">
                        </div>
                        <div class="col-12">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="filterIsGlobal">
                                <label class="form-check-label" for="filterIsGlobal">
                                    Tornar filtro público (visível para todos)
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-filter me-1"></i> Aplicar Filtros
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Export Modal -->
<div class="modal fade" id="exportModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-file-export me-2"></i>Exportar Tarefas</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Formato</label>
                    <select class="form-select" id="exportFormat" required>
                        <option value="excel" selected>Excel (.xlsx)</option>
                        <option value="csv">CSV (.csv)</option>
                        <option value="pdf">PDF (.pdf)</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Filtros atuais</label>
                    <div class="form-control" style="min-height: 80px; max-height: 150px; overflow-y: auto;">
                        {% if filter_params %}
                            {% for key, value in filter_params.items() %}
                                {% if value and value != 'false' and value != 'true' %}
                                <span class="badge bg-info me-1 mb-1">{{ key }}: {{ value }}</span>
                                {% endif %}
                            {% endfor %}
                        {% else %}
                        <span class="text-muted">Todos os filtros serão aplicados</span>
                        {% endif %}
                    </div>
                </div>
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="includeAttachments">
                    <label class="form-check-label" for="includeAttachments">
                        Incluir anexos (se disponível)
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" id="confirmExport">
                    <i class="fas fa-download me-1"></i> Exportar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Actions Modal -->
<div class="modal fade" id="bulkActionsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-tasks me-2"></i>
                    <span id="selectedCount">0</span> tarefas selecionadas
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Ação</label>
                    <select class="form-select" id="bulkActionSelect">
                        <option value="">Selecione uma ação...</option>
                        <option value="complete">Marcar como concluídas</option>
                        <option value="in_progress">Marcar como em progresso</option>
                        <option value="not_started">Marcar como não iniciadas</option>
                        <option value="priority">Alterar prioridade</option>
                        <option value="assign">Atribuir a...</option>
                        <option value="move">Mover para planner...</option>
                        <option value="delete">Excluir tarefas</option>
                    </select>
                </div>
                
                <div id="bulkActionOptions" style="display: none;">
                    <!-- Options will be loaded based on selected action -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="executeBulkAction">
                    <i class="fas fa-play me-1"></i> Executar
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // Initialize tooltips
    $('[data-bs-toggle="tooltip"]').tooltip();
    
    // View toggling
    $('#viewTable').click(function() {
        $('.view-toggle .btn').removeClass('active');
        $(this).addClass('active');
        $('.view-content').hide();
        $('#tableView').show();
    });
    
    $('#viewKanban').click(function() {
        $('.view-toggle .btn').removeClass('active');
        $(this).addClass('active');
        $('.view-content').hide();
        $('#kanbanView').show();
        loadKanbanView();
    });
    
    $('#viewCards').click(function() {
        $('.view-toggle .btn').removeClass('active');
        $(this).addClass('active');
        $('.view-content').hide();
        $('#cardsView').show();
        loadCardsView();
    });
    
    // Filter button click
    $('#filterButton').click(function() {
        $('#filterModal').modal('show');
    });
    
    // Export button click
    $('#exportButton').click(function() {
        $('#exportModal').modal('show');
    });
    
    // Confirm export button
    $('#confirmExport').click(function() {
        exportTasks();
    });
    
    // Filter form handling
    $('#dateRangeSelect').change(function() {
        if ($(this).val() === 'custom') {
            $('#customDateRange').show();
        } else {
            $('#customDateRange').hide();
        }
    });
    
    $('#saveFilterCheck').change(function() {
        if ($(this).is(':checked')) {
            $('#saveFilterOptions').show();
        } else {
            $('#saveFilterOptions').hide();
        }
    });
    
    // Select all checkbox
    $('#selectAll').change(function() {
        const isChecked = $(this).is(':checked');
        $('.task-checkbox').prop('checked', isChecked);
        updateSelectedCount();
    });
    
    // Individual checkbox change
    $(document).on('change', '.task-checkbox', function() {
        updateSelectedCount();
    });
    
    // Initialize date range visibility
    if ($('#dateRangeSelect').val() === 'custom') {
        $('#customDateRange').show();
    }
    
    // Fix for modal backdrop issue
    $(document).on('show.bs.modal', '.modal', function() {
        const zIndex = 1040 + (10 * $('.modal:visible').length);
        $(this).css('z-index', zIndex);
        setTimeout(() => {
            $('.modal-backdrop').not('.modal-stack').css('z-index', zIndex - 1).addClass('modal-stack');
        }, 0);
    });
});

function updateSelectedCount() {
    const selectedCount = $('.task-checkbox:checked').length;
    $('#selectedCount').text(selectedCount);
    
    if (selectedCount > 0) {
        $('#bulkActionsModal').modal('show');
    }
}

function quickUpdateStatus(taskId, status) {
    apiRequest(`/api/tasks/${taskId}/status`, 'POST', { status: status })
        .then(response => {
            if (response.success) {
                showToast('Sucesso', 'Status atualizado com sucesso', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast('Erro', response.error || 'Erro ao atualizar status', 'danger');
            }
        })
        .catch(error => {
            showToast('Erro', 'Erro: ' + error.message, 'danger');
        });
    return false;
}

function editTask(taskId) {
    // Implement task editing
    alert('Editar tarefa ' + taskId + ' - Em desenvolvimento');
    return false;
}

function confirmDelete(taskId) {
    if (confirm('Tem certeza que deseja excluir esta tarefa?')) {
        apiRequest(`/api/tasks/${taskId}`, 'DELETE')
            .then(response => {
                if (response.success) {
                    showToast('Sucesso', 'Tarefa excluída com sucesso', 'success');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showToast('Erro', response.error || 'Erro ao excluir tarefa', 'danger');
                }
            })
            .catch(error => {
                showToast('Erro', 'Erro: ' + error.message, 'danger');
            });
    }
    return false;
}

function exportTasks() {
    const format = $('#exportFormat').val();
    const includeAttachments = $('#includeAttachments').is(':checked');
    
    // Get current filter params from URL
    const urlParams = new URLSearchParams(window.location.search);
    const filters = {};
    
    for (const [key, value] of urlParams.entries()) {
        if (key !== 'page' && key !== 'per_page' && value !== 'false' && value !== 'true') {
            filters[key] = value;
        }
    }
    
    const formData = {
        filters: filters,
        format: format,
        include_attachments: includeAttachments
    };
    
    apiRequest('/api/export/tasks', 'POST', formData)
        .then(response => {
            if (response.success) {
                showToast('Sucesso', 'Exportação iniciada. O arquivo será baixado em breve.', 'success');
                $('#exportModal').modal('hide');
            } else {
                showToast('Erro', response.error || 'Erro ao exportar', 'danger');
            }
        })
        .catch(error => {
            showToast('Erro', 'Erro ao exportar: ' + error.message, 'danger');
        });
}

function loadKanbanView() {
    // Clear columns first
    $('.kanban-column-content').empty();
    
    // Get tasks from current page
    const tasksData = [
        {% if tasks and tasks.items %}
        {% for task_item in tasks.items %}
        {
            id: '{{ task_item.id }}',
            title: '{{ task_item.title|replace("'", "\\'")|replace('"', '\\"') if task_item.title else "" }}',
            description: '{{ task_item.description|replace("'", "\\'")|replace('"', '\\"') if task_item.description else "" }}',
            status: '{{ task_item.status.value if task_item.status else "not_started" }}',
            priority: {{ task_item.priority.value if task_item.priority else 0 }},
            percent_complete: {{ task_item.percent_complete if task_item.percent_complete else 0 }},
            due_date: '{{ task_item.due_date.isoformat() if task_item.due_date else "" }}',
            is_overdue: {{ 'true' if task_item.is_overdue else 'false' }},
            planner_title: '{{ task_item.planner.title|replace("'", "\\'")|replace('"', '\\"') if task_item.planner and task_item.planner.title else "" }}',
            assignments: {{ task_item.get_assignments()|tojson if task_item.get_assignments() else "{}" }}
        },
        {% endfor %}
        {% endif %}
    ];
    
    // Count tasks by status
    const counts = {
        'not_started': 0,
        'in_progress': 0,
        'completed': 0,
        'overdue': 0
    };
    
    // Add tasks to columns and count
    tasksData.forEach(task => {
        const status = task.status || 'not_started';
        counts[status] = (counts[status] || 0) + 1;
        
        const column = $(`[data-status="${status}"]`);
        if (column.length) {
            column.append(createKanbanCard(task));
        }
    });
    
    // Update counters
    $('#notStartedCount').text(counts['not_started'] || 0);
    $('#inProgressCount').text(counts['in_progress'] || 0);
    $('#completedCount').text(counts['completed'] || 0);
    $('#overdueCount').text(counts['overdue'] || 0);
    
    // Make cards draggable
    makeKanbanDraggable();
}

function createKanbanCard(task) {
    const priorityColors = {
        3: 'priority-urgent',
        2: 'priority-high',
        1: 'priority-medium',
        0: 'priority-low'
    };
    
    const statusColors = {
        'not_started': 'border-left-secondary',
        'in_progress': 'border-left-warning',
        'completed': 'border-left-success',
        'overdue': 'border-left-danger',
        'blocked': 'border-left-dark'
    };
    
    let assigneeAvatars = '';
    if (task.assignments && typeof task.assignments === 'object') {
        const assignments = task.assignments;
        const userIds = Object.keys(assignments);
        let avatarCount = 0;
        
        for (const userId of userIds) {
            if (avatarCount >= 2) break;
            const assignee = assignments[userId];
            if (assignee) {
                const displayName = assignee.userDisplayName || assignee.userEmail || 'Usuário';
                const initials = displayName[0].toUpperCase();
                assigneeAvatars += `
                    <div class="avatar avatar-sm" title="${displayName}">
                        <span class="avatar-initials bg-primary text-white">${initials}</span>
                    </div>
                `;
                avatarCount++;
            }
        }
        
        if (userIds.length > 2) {
            assigneeAvatars += `
                <div class="avatar avatar-sm">
                    <span class="avatar-initials bg-secondary text-white">+${userIds.length - 2}</span>
                </div>
            `;
        }
    }
    
    const priorityClass = priorityColors[task.priority] || 'priority-low';
    const statusClass = statusColors[task.status] || 'border-left-secondary';
    const priorityChar = task.priority == 3 ? 'U' : task.priority == 2 ? 'A' : task.priority == 1 ? 'M' : 'B';
    
    return `
        <div class="card task-card task-draggable mb-2 ${statusClass}" 
             data-task-id="${task.id}" data-status="${task.status}">
            <div class="card-body p-3">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <div class="d-flex align-items-center">
                        <span class="task-priority-badge ${priorityClass} me-2" title="${task.priority == 3 ? 'Urgente' : task.priority == 2 ? 'Alta' : task.priority == 1 ? 'Média' : 'Baixa'}">
                            ${priorityChar}
                        </span>
                        <small class="text-muted">${task.planner_title || 'Sem planner'}</small>
                    </div>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-link text-muted p-0" data-bs-toggle="dropdown">
                            <i class="fas fa-ellipsis-h"></i>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="/tasks/${task.id}">Detalhes</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="return quickUpdateStatus('${task.id}', 'completed')">Concluir</a></li>
                        </ul>
                    </div>
                </div>
                
                <h6 class="card-title mb-2" style="font-size: 0.9rem;">${task.title.length > 50 ? task.title.substring(0, 50) + '...' : task.title}</h6>
                
                <div class="d-flex justify-content-between align-items-center mt-3">
                    <div class="progress progress-thin flex-grow-1 me-2">
                        <div class="progress-bar" style="width: ${task.percent_complete}%"></div>
                    </div>
                    <small>${task.percent_complete}%</small>
                </div>
                
                ${task.due_date ? `
                <div class="mt-2">
                    <small class="text-muted">
                        <i class="far fa-clock me-1"></i>
                        ${new Date(task.due_date).toLocaleDateString('pt-BR')}
                    </small>
                </div>` : ''}
                
                ${assigneeAvatars ? `
                <div class="mt-2">
                    <div class="avatar-group">
                        ${assigneeAvatars}
                    </div>
                </div>` : ''}
            </div>
        </div>
    `;
}

function makeKanbanDraggable() {
    const draggables = document.querySelectorAll('.task-draggable');
    const columns = document.querySelectorAll('.kanban-column-content');
    
    draggables.forEach(draggable => {
        draggable.setAttribute('draggable', 'true');
        
        draggable.addEventListener('dragstart', (e) => {
            e.dataTransfer.setData('text/plain', draggable.dataset.taskId);
            draggable.classList.add('dragging');
        });
        
        draggable.addEventListener('dragend', () => {
            draggable.classList.remove('dragging');
            columns.forEach(col => col.classList.remove('drop-target'));
        });
    });
    
    columns.forEach(column => {
        column.addEventListener('dragover', (e) => {
            e.preventDefault();
            column.classList.add('drop-target');
        });
        
        column.addEventListener('dragleave', () => {
            column.classList.remove('drop-target');
        });
        
        column.addEventListener('drop', (e) => {
            e.preventDefault();
            column.classList.remove('drop-target');
            
            const taskId = e.dataTransfer.getData('text/plain');
            const newStatus = column.dataset.status;
            const draggable = document.querySelector(`[data-task-id="${taskId}"]`);
            
            if (draggable && newStatus) {
                // Update task status via API
                apiRequest(`/api/tasks/${taskId}/status`, 'POST', { status: newStatus })
                    .then(response => {
                        if (response.success) {
                            // Move card to new column
                            column.appendChild(draggable);
                            draggable.dataset.status = newStatus;
                            showToast('Sucesso', 'Tarefa movida', 'success');
                        }
                    });
            }
        });
    });
}

function loadCardsView() {
    const container = $('#cardsContainer');
    container.empty();
    
    // Get tasks from current page
    const tasksData = [
        {% if tasks and tasks.items %}
        {% for task_item in tasks.items %}
        {
            id: '{{ task_item.id }}',
            title: '{{ task_item.title|replace("'", "\\'")|replace('"', '\\"') if task_item.title else "" }}',
            description: '{{ task_item.description|replace("'", "\\'")|replace('"', '\\"') if task_item.description else "" }}',
            status: '{{ task_item.status.value if task_item.status else "not_started" }}',
            priority: {{ task_item.priority.value if task_item.priority else 0 }},
            percent_complete: {{ task_item.percent_complete if task_item.percent_complete else 0 }},
            due_date: '{{ task_item.due_date.isoformat() if task_item.due_date else "" }}',
            is_overdue: {{ 'true' if task_item.is_overdue else 'false' }},
            planner_title: '{{ task_item.planner.title|replace("'", "\\'")|replace('"', '\\"') if task_item.planner and task_item.planner.title else "" }}',
            assignments: {{ task_item.get_assignments()|tojson if task_item.get_assignments() else "{}" }}
        },
        {% endfor %}
        {% endif %}
    ];
    
    tasksData.forEach(task => {
        container.append(createTaskCard(task));
    });
}

function createTaskCard(task) {
    const priorityLabels = {
        3: { label: 'Urgente', class: 'danger' },
        2: { label: 'Alta', class: 'danger' },
        1: { label: 'Média', class: 'warning' },
        0: { label: 'Baixa', class: 'info' }
    };
    
    const priority = priorityLabels[task.priority] || priorityLabels[0];
    
    const statusLabels = {
        'not_started': { label: 'Não Iniciada', class: 'secondary' },
        'in_progress': { label: 'Em Progresso', class: 'warning' },
        'completed': { label: 'Concluída', class: 'success' },
        'overdue': { label: 'Atrasada', class: 'danger' },
        'blocked': { label: 'Bloqueada', class: 'dark' }
    };
    
    const status = statusLabels[task.status] || statusLabels['not_started'];
    
    let assigneeAvatars = '';
    if (task.assignments && typeof task.assignments === 'object') {
        const assignments = task.assignments;
        const userIds = Object.keys(assignments);
        
        for (const userId of userIds) {
            const assignee = assignments[userId];
            if (assignee) {
                const displayName = assignee.userDisplayName || assignee.userEmail || 'Usuário';
                const initials = displayName[0].toUpperCase();
                assigneeAvatars += `
                    <div class="avatar avatar-sm" title="${displayName}">
                        <span class="avatar-initials bg-primary text-white">${initials}</span>
                    </div>
                `;
            }
        }
    }
    
    const dueDateText = task.due_date ? new Date(task.due_date).toLocaleDateString('pt-BR') : 'Sem data';
    
    return `
        <div class="col-md-4 col-lg-3 mb-4">
            <div class="card h-100 task-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div>
                            <span class="badge bg-${priority.class}">${priority.label}</span>
                            <span class="badge bg-${status.class}">${status.label}</span>
                        </div>
                        <div class="dropdown">
                            <button class="btn btn-sm btn-link text-muted p-0" data-bs-toggle="dropdown">
                                <i class="fas fa-ellipsis-h"></i>
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="/tasks/${task.id}">Detalhes</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#" onclick="return quickUpdateStatus('${task.id}', 'completed')">Concluir</a></li>
                            </ul>
                        </div>
                    </div>
                    
                    <h6 class="card-title" style="font-size: 0.9rem;">${task.title.length > 80 ? task.title.substring(0, 80) + '...' : task.title}</h6>
                    ${task.description ? `<p class="card-text text-muted small mt-2">${task.description.length > 100 ? task.description.substring(0, 100) + '...' : task.description}</p>` : ''}
                    
                    <div class="mt-3 mb-3">
                        <div class="progress progress-thin">
                            <div class="progress-bar" style="width: ${task.percent_complete}%"></div>
                        </div>
                        <small class="text-muted">${task.percent_complete}% completo</small>
                    </div>
                    
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div>
                            <small class="text-muted"><i class="far fa-clock me-1"></i>Vencimento</small>
                            <div>${dueDateText}</div>
                        </div>
                        ${task.is_overdue ? '<span class="badge bg-danger">Atrasada</span>' : ''}
                    </div>
                    
                    ${assigneeAvatars ? `
                    <div class="mt-3">
                        <small class="text-muted d-block mb-1">Responsáveis</small>
                        <div class="avatar-group">
                            ${assigneeAvatars}
                        </div>
                    </div>` : ''}
                    
                    <div class="mt-3">
                        <small class="text-muted"><i class="fas fa-project-diagram me-1"></i>${task.planner_title || 'Sem planner'}</small>
                    </div>
                </div>
                <div class="card-footer bg-transparent border-top-0 pt-0">
                    <a href="/tasks/${task.id}" class="btn btn-sm btn-outline-primary w-100">
                        <i class="fas fa-eye me-1"></i> Ver detalhes
                    </a>
                </div>
            </div>
        </div>
    `;
}
</script>
{% endblock %}